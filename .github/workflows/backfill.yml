name: cryptopipe-backfill
on:
  workflow_dispatch:
    inputs:
      days:
        description: "How many days to backfill"
        default: "365"
        required: true

jobs:
  backfill:
    runs-on: ubuntu-latest
    env:
      DB_HOST: ${{ secrets.DB_HOST }}
      DB_NAME: ${{ secrets.DB_NAME }}
      DB_USER: ${{ secrets.DB_USER }}
      DB_PASS: ${{ secrets.DB_PASS }}
      DB_PORT: ${{ secrets.DB_PORT }}
      SYMBOLS: BTC-USD, ETH-USD, XRP-USD, LTC-USD, BCH-USD, LINK-USD, ADA-USD, XLM-USD, SOL-USD, DOT-USD, MATIC-USD, DOGE-USD, AVAX-USD, TRX-USD, ATOM-USD, ETC-USD, ALGO-USD, XMR-USD, ICP-USD, NEAR-USD, FIL-USD, APT-USD, HBAR-USD, UNI-USD, AAVE-USD, MKR-USD, SNX-USD, INJ-USD, STX-USD, GRT-USD
      BACKFILL_DAYS: ${{ github.event.inputs.days }}
      TRAIN_WINDOW_DAYS: "0"           
      USE_DEEP: "0"                    
      USE_PROPHET: "0"                 
      LOG_SPACE: "1"  
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with: { python-version: "3.11" }
      - run: |
          python -m pip install --upgrade pip
          pip install -r pipeline/requirements.txt
      - name: Backfill + ETL + insights
        run: |
          python pipeline/ingest.py
          python pipeline/run_etl.py
          python pipeline/generate_insight.py
